<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NBA Live Trades</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #0f1115;
            color: #e4e4e7;
            min-height: 100vh;
        }

        /* Header */
        .header {
            background: #18181b;
            border-bottom: 1px solid #27272a;
            padding: 16px 24px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .header-left {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .header h1 {
            font-size: 20px;
            font-weight: 700;
            color: #fff;
        }
        .connection-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
        }
        .connection-badge.connected {
            background: rgba(34, 197, 94, 0.15);
            color: #22c55e;
        }
        .connection-badge.disconnected {
            background: rgba(239, 68, 68, 0.15);
            color: #ef4444;
        }
        .connection-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: currentColor;
        }
        .connection-badge.connected .connection-dot {
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.4; }
        }
        .header-stats {
            display: flex;
            gap: 20px;
            font-size: 13px;
            color: #a1a1aa;
        }
        .header-stat-value {
            color: #fff;
            font-weight: 600;
        }

        /* Filters */
        .filters {
            background: #18181b;
            border-bottom: 1px solid #27272a;
            padding: 12px 24px;
            display: flex;
            align-items: center;
            gap: 16px;
            flex-wrap: wrap;
        }
        .filter-group {
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .filter-label {
            font-size: 12px;
            color: #71717a;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-weight: 600;
        }
        .filter-input {
            background: #27272a;
            border: 1px solid #3f3f46;
            color: #e4e4e7;
            border-radius: 6px;
            padding: 6px 10px;
            font-size: 13px;
            width: 80px;
        }
        .filter-input:focus { outline: none; border-color: #6366f1; }

        .toggle-group {
            display: flex;
            border-radius: 6px;
            overflow: hidden;
            border: 1px solid #3f3f46;
        }
        .toggle-btn {
            background: #27272a;
            border: none;
            color: #a1a1aa;
            padding: 6px 12px;
            font-size: 12px;
            cursor: pointer;
            font-weight: 500;
            border-right: 1px solid #3f3f46;
            transition: all 0.15s;
        }
        .toggle-btn:last-child { border-right: none; }
        .toggle-btn:hover { background: #3f3f46; }
        .toggle-btn.active {
            background: #6366f1;
            color: #fff;
        }

        .filter-select {
            background: #27272a;
            border: 1px solid #3f3f46;
            color: #e4e4e7;
            border-radius: 6px;
            padding: 6px 10px;
            font-size: 13px;
        }
        .filter-select:focus { outline: none; border-color: #6366f1; }

        /* Main Layout */
        .main {
            display: flex;
            height: calc(100vh - 110px);
        }

        /* Feed Panel */
        .feed-panel {
            flex: 6;
            overflow-y: auto;
            padding: 16px 24px;
            border-right: 1px solid #27272a;
        }
        .feed-panel::-webkit-scrollbar { width: 6px; }
        .feed-panel::-webkit-scrollbar-track { background: transparent; }
        .feed-panel::-webkit-scrollbar-thumb { background: #3f3f46; border-radius: 3px; }

        .feed-empty {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 300px;
            color: #52525b;
            font-size: 14px;
            gap: 8px;
        }
        .feed-empty-icon { font-size: 32px; }

        /* Trade Card */
        .trade-card {
            background: #18181b;
            border: 1px solid #27272a;
            border-radius: 8px;
            padding: 12px 16px;
            margin-bottom: 8px;
            border-left: 3px solid;
            animation: slideIn 0.3s ease-out;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
        }
        .trade-card.yes { border-left-color: #22c55e; }
        .trade-card.no { border-left-color: #ef4444; }

        @keyframes slideIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .trade-left {
            display: flex;
            align-items: center;
            gap: 12px;
            flex: 1;
            min-width: 0;
        }
        .trade-side-badge {
            font-size: 11px;
            font-weight: 700;
            padding: 3px 8px;
            border-radius: 4px;
            text-transform: uppercase;
            flex-shrink: 0;
        }
        .trade-side-badge.yes {
            background: rgba(34, 197, 94, 0.15);
            color: #22c55e;
        }
        .trade-side-badge.no {
            background: rgba(239, 68, 68, 0.15);
            color: #ef4444;
        }
        .trade-info {
            display: flex;
            flex-direction: column;
            gap: 2px;
            min-width: 0;
        }
        .trade-player {
            font-weight: 600;
            font-size: 14px;
            color: #fff;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .trade-detail {
            font-size: 12px;
            color: #a1a1aa;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .prop-badge {
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 3px;
            font-weight: 600;
            text-transform: uppercase;
        }
        .prop-badge.points { background: rgba(99, 102, 241, 0.2); color: #818cf8; }
        .prop-badge.rebounds { background: rgba(245, 158, 11, 0.2); color: #fbbf24; }
        .prop-badge.assists { background: rgba(34, 197, 94, 0.2); color: #4ade80; }
        .prop-badge.threes { background: rgba(168, 85, 247, 0.2); color: #c084fc; }

        .trade-right {
            display: flex;
            align-items: center;
            gap: 16px;
            flex-shrink: 0;
        }
        .trade-price {
            font-size: 14px;
            font-weight: 600;
            color: #fff;
            text-align: right;
        }
        .trade-contracts {
            font-size: 12px;
            color: #a1a1aa;
            text-align: right;
            white-space: nowrap;
        }
        .trade-dollar {
            font-size: 14px;
            font-weight: 700;
            color: #fbbf24;
            min-width: 70px;
            text-align: right;
        }
        .trade-ev {
            font-size: 13px;
            font-weight: 700;
            min-width: 60px;
            text-align: right;
        }
        .trade-ev.positive { color: #22c55e; }
        .trade-ev.negative { color: #ef4444; }
        .trade-ev.neutral { color: #71717a; }
        .trade-time {
            font-size: 11px;
            color: #52525b;
            min-width: 60px;
            text-align: right;
        }

        /* Stats Panel */
        .stats-panel {
            flex: 4;
            overflow-y: auto;
            padding: 16px 24px;
        }
        .stats-panel::-webkit-scrollbar { width: 6px; }
        .stats-panel::-webkit-scrollbar-track { background: transparent; }
        .stats-panel::-webkit-scrollbar-thumb { background: #3f3f46; border-radius: 3px; }

        .stats-section {
            margin-bottom: 24px;
        }
        .stats-section-title {
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: #71717a;
            font-weight: 600;
            margin-bottom: 12px;
        }

        .summary-cards {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 8px;
            margin-bottom: 24px;
        }
        .summary-card {
            background: #18181b;
            border: 1px solid #27272a;
            border-radius: 8px;
            padding: 12px;
            text-align: center;
        }
        .summary-value {
            font-size: 20px;
            font-weight: 700;
            color: #fff;
        }
        .summary-label {
            font-size: 11px;
            color: #71717a;
            margin-top: 4px;
            text-transform: uppercase;
        }

        /* Player/Market list */
        .stat-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #1e1e22;
        }
        .stat-row:last-child { border-bottom: none; }
        .stat-rank {
            font-size: 12px;
            color: #52525b;
            width: 20px;
            font-weight: 600;
        }
        .stat-name {
            flex: 1;
            font-size: 13px;
            color: #e4e4e7;
            margin-left: 8px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .stat-volume {
            font-size: 13px;
            font-weight: 600;
            color: #fbbf24;
        }

        /* Prop type bars */
        .prop-bar-container {
            margin-bottom: 8px;
        }
        .prop-bar-header {
            display: flex;
            justify-content: space-between;
            font-size: 12px;
            margin-bottom: 4px;
        }
        .prop-bar-name { color: #a1a1aa; }
        .prop-bar-value { color: #fff; font-weight: 600; }
        .prop-bar-track {
            height: 6px;
            background: #27272a;
            border-radius: 3px;
            overflow: hidden;
        }
        .prop-bar-fill {
            height: 100%;
            border-radius: 3px;
            transition: width 0.5s ease;
        }
        .prop-bar-fill.points { background: #6366f1; }
        .prop-bar-fill.rebounds { background: #f59e0b; }
        .prop-bar-fill.assists { background: #22c55e; }
        .prop-bar-fill.threes { background: #a855f7; }

        /* Cheap NOs Feed */
        .cheap-nos-feed {
            max-height: 300px;
            overflow-y: auto;
        }
        .cheap-nos-feed::-webkit-scrollbar { width: 6px; }
        .cheap-nos-feed::-webkit-scrollbar-track { background: transparent; }
        .cheap-nos-feed::-webkit-scrollbar-thumb { background: #3f3f46; border-radius: 3px; }

        .cheap-no-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 10px;
            padding: 8px 10px;
            background: #18181b;
            border: 1px solid #27272a;
            border-left: 3px solid #ef4444;
            border-radius: 6px;
            margin-bottom: 6px;
        }
        .cheap-no-left {
            display: flex;
            align-items: center;
            gap: 8px;
            flex: 1;
            min-width: 0;
        }
        .cheap-no-player {
            font-weight: 600;
            font-size: 13px;
            color: #fff;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .cheap-no-line {
            font-size: 11px;
            color: #a1a1aa;
        }
        .cheap-no-right {
            display: flex;
            align-items: center;
            gap: 10px;
            flex-shrink: 0;
        }
        .cheap-no-price {
            font-size: 16px;
            font-weight: 700;
            color: #ef4444;
        }
        .cheap-no-qty {
            font-size: 11px;
            color: #71717a;
        }
        .cheap-no-dismiss {
            background: none;
            border: none;
            color: #52525b;
            cursor: pointer;
            font-size: 14px;
            padding: 2px 4px;
            line-height: 1;
            border-radius: 3px;
        }
        .cheap-no-dismiss:hover {
            color: #ef4444;
            background: rgba(239, 68, 68, 0.1);
        }
        .unhide-btn {
            background: none;
            border: 1px solid #3f3f46;
            color: #a1a1aa;
            font-size: 11px;
            padding: 3px 8px;
            border-radius: 4px;
            cursor: pointer;
        }
        .unhide-btn:hover {
            color: #fff;
            border-color: #6366f1;
        }

        @media (max-width: 900px) {
            .main { flex-direction: column; height: auto; }
            .feed-panel { border-right: none; border-bottom: 1px solid #27272a; max-height: 60vh; }
            .stats-panel { max-height: 40vh; }
            .summary-cards { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <div class="header">
        <div class="header-left">
            <h1>NBA Live Trades</h1>
            <span id="connectionBadge" class="connection-badge disconnected">
                <span class="connection-dot"></span>
                <span id="connectionText">Connecting...</span>
            </span>
        </div>
        <div class="header-stats">
            <span>Trades: <span id="headerTrades" class="header-stat-value">0</span></span>
            <span>Volume: <span id="headerVolume" class="header-stat-value">$0</span></span>
            <span>Tickers: <span id="headerTickers" class="header-stat-value">--</span></span>
        </div>
    </div>

    <!-- Filters -->
    <div class="filters">
        <div class="filter-group">
            <span class="filter-label">Min $</span>
            <input type="number" id="filterMinDollar" class="filter-input" value="0" min="0" step="10">
        </div>

        <div class="filter-group">
            <span class="filter-label">Side</span>
            <div class="toggle-group" id="filterSide">
                <button class="toggle-btn active" data-value="all">All</button>
                <button class="toggle-btn" data-value="yes">Yes</button>
                <button class="toggle-btn" data-value="no">No</button>
            </div>
        </div>

        <div class="filter-group">
            <span class="filter-label">Prop</span>
            <div class="toggle-group" id="filterProp">
                <button class="toggle-btn active" data-value="all">All</button>
                <button class="toggle-btn" data-value="Points">PTS</button>
                <button class="toggle-btn" data-value="Rebounds">REB</button>
                <button class="toggle-btn" data-value="Assists">AST</button>
                <button class="toggle-btn" data-value="Threes">3PT</button>
            </div>
        </div>

        <div class="filter-group">
            <span class="filter-label">Game</span>
            <div class="toggle-group" id="filterGame" style="flex-wrap: wrap; gap: 2px;">
                <button class="toggle-btn active" data-value="all">All</button>
            </div>
        </div>

        <div class="filter-group">
            <span class="filter-label">Time Range</span>
            <div class="toggle-group" id="statsTimeRange" style="flex-wrap: wrap;">
                <button class="toggle-btn" data-value="300">5m</button>
                <button class="toggle-btn" data-value="900">15m</button>
                <button class="toggle-btn" data-value="1800">30m</button>
                <button class="toggle-btn" data-value="3600">1h</button>
                <button class="toggle-btn" data-value="10800">3h</button>
                <button class="toggle-btn active" data-value="21600">6h</button>
                <button class="toggle-btn" data-value="43200">12h</button>
                <button class="toggle-btn" data-value="86400">24h</button>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="main">
        <div class="feed-panel" id="feedPanel">
            <div class="feed-empty" id="feedEmpty">
                <div class="feed-empty-icon">&#9889;</div>
                <div>Waiting for trades...</div>
                <div style="font-size: 12px;">NBA prop trades will appear here in real-time</div>
            </div>
        </div>

        <div class="stats-panel">
            <!-- Cheap NO Contracts -->
            <div class="stats-section">
                <div style="display:flex;align-items:center;justify-content:space-between;">
                    <div class="stats-section-title" style="margin-bottom:0;">Cheap NO Contracts (&le;10&cent;)</div>
                    <button class="unhide-btn" id="unhideAllBtn" onclick="state.hiddenTickers.clear();renderCheapNos();" style="display:none;">Unhide all</button>
                </div>
                <div class="cheap-nos-feed" id="cheapNosFeed">
                    <div style="color: #52525b; font-size: 13px;">Scanning orderbooks...</div>
                </div>
            </div>

            <!-- Summary -->
            <div class="summary-cards">
                <div class="summary-card">
                    <div class="summary-value" id="statTotalTrades">0</div>
                    <div class="summary-label">Trades</div>
                </div>
                <div class="summary-card">
                    <div class="summary-value" id="statTotalContracts">0</div>
                    <div class="summary-label">Contracts</div>
                </div>
                <div class="summary-card">
                    <div class="summary-value" id="statTotalVolume">$0</div>
                    <div class="summary-label">Volume</div>
                </div>
            </div>

            <!-- Hot Markets -->
            <div class="stats-section">
                <div class="stats-section-title">Hot Markets</div>
                <div id="hotMarkets">
                    <div style="color: #52525b; font-size: 13px;">No data yet</div>
                </div>
            </div>

            <!-- Volume by Prop Type -->
            <div class="stats-section">
                <div class="stats-section-title">Volume by Prop Type</div>
                <div id="propTypeBars">
                    <div style="color: #52525b; font-size: 13px;">No data yet</div>
                </div>
            </div>

            <!-- Top Trades -->
            <div class="stats-section">
                <div class="stats-section-title">Top Trades</div>
                <div id="topTrades">
                    <div style="color: #52525b; font-size: 13px;">No data yet</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ============================================================
        // STATE
        // ============================================================
        const state = {
            trades: [],
            stats: {},
            filters: {
                minDollar: 0,
                side: 'all',
                propType: 'all',
                games: new Set(), // empty = all games
            },
            cheapNos: [],
            hiddenTickers: new Set(),
            statsWindow: 21600, // 6h default
            loadingMore: false,
            allLoaded: false,
            connected: false,
        };

        // ============================================================
        // FILTERS
        // ============================================================
        function passesFilter(trade) {
            if (trade.dollar_amount < state.filters.minDollar) return false;
            if (state.filters.side !== 'all' && trade.taker_side !== state.filters.side) return false;
            if (state.filters.propType !== 'all' && trade.prop_type !== state.filters.propType) return false;
            if (state.filters.games.size > 0 && !state.filters.games.has(trade.game_slug)) return false;
            return true;
        }

        // Toggle button setup
        document.querySelectorAll('.toggle-group').forEach(group => {
            group.querySelectorAll('.toggle-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    group.querySelectorAll('.toggle-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');

                    const filterId = group.id;
                    const value = btn.dataset.value;
                    if (filterId === 'filterSide') state.filters.side = value;
                    if (filterId === 'filterProp') state.filters.propType = value;
                    refilterFeed();
                });
            });
        });

        document.getElementById('filterMinDollar').addEventListener('input', (e) => {
            state.filters.minDollar = parseFloat(e.target.value) || 0;
            refilterFeed();
        });

        function setupGameFilters() {
            const group = document.getElementById('filterGame');
            group.addEventListener('click', (e) => {
                const btn = e.target.closest('.toggle-btn');
                if (!btn) return;
                const value = btn.dataset.value;

                if (value === 'all') {
                    // Clear all selections
                    state.filters.games.clear();
                    group.querySelectorAll('.toggle-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                } else {
                    // Toggle this game
                    const allBtn = group.querySelector('[data-value="all"]');
                    if (state.filters.games.has(value)) {
                        state.filters.games.delete(value);
                        btn.classList.remove('active');
                    } else {
                        state.filters.games.add(value);
                        btn.classList.add('active');
                    }
                    // If nothing selected, re-activate "All"
                    if (state.filters.games.size === 0) {
                        allBtn.classList.add('active');
                    } else {
                        allBtn.classList.remove('active');
                    }
                }
                refilterFeed();
            });
        }
        setupGameFilters();

        // Stats time range toggle
        document.getElementById('statsTimeRange').querySelectorAll('.toggle-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.getElementById('statsTimeRange').querySelectorAll('.toggle-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                state.statsWindow = parseInt(btn.dataset.value);
                fetchStats();
            });
        });

        async function fetchStats() {
            try {
                const resp = await fetch(`/api/stats?window=${state.statsWindow}`);
                if (resp.ok) {
                    state.stats = await resp.json();
                    renderStats();
                }
            } catch (e) { /* ignore fetch errors */ }
        }

        // Poll stats every 15s
        setInterval(fetchStats, 15000);

        function refilterFeed() {
            const feedPanel = document.getElementById('feedPanel');
            const cards = feedPanel.querySelectorAll('.trade-card');
            let visible = 0;
            cards.forEach(card => {
                const idx = parseInt(card.dataset.index);
                const trade = state.trades[idx];
                if (trade && passesFilter(trade)) {
                    card.style.display = 'flex';
                    visible++;
                } else {
                    card.style.display = 'none';
                }
            });
            const empty = document.getElementById('feedEmpty');
            if (empty) empty.style.display = visible === 0 && state.trades.length > 0 ? 'none' : (state.trades.length === 0 ? 'flex' : 'none');
        }

        // ============================================================
        // RENDERING
        // ============================================================
        function formatDollar(amount) {
            if (amount >= 1000) return '$' + (amount / 1000).toFixed(1) + 'k';
            return '$' + amount.toFixed(2);
        }

        function formatNumber(n) {
            if (n >= 1000000) return (n / 1000000).toFixed(1) + 'M';
            if (n >= 1000) return (n / 1000).toFixed(1) + 'k';
            return n.toString();
        }

        function createTradeCard(trade, index, animate) {
            const side = trade.taker_side;
            const propClass = trade.prop_type.toLowerCase();
            const priceDisplay = side === 'yes'
                ? `${trade.yes_price}\u00A2 YES`
                : `${trade.no_price}\u00A2 NO`;

            const card = document.createElement('div');
            card.className = `trade-card ${side}`;
            card.dataset.index = index;
            if (!animate) card.style.animation = 'none';
            if (!passesFilter(trade)) card.style.display = 'none';

            let evHtml = '';
            if (trade.ev_percent !== null && trade.ev_percent !== undefined) {
                const evClass = trade.ev_percent > 0 ? 'positive' : trade.ev_percent < 0 ? 'negative' : 'neutral';
                const evSign = trade.ev_percent > 0 ? '+' : '';
                evHtml = `<div class="trade-ev ${evClass}">${evSign}${trade.ev_percent.toFixed(1)}%</div>`;
            } else {
                evHtml = `<div class="trade-ev neutral">--</div>`;
            }

            card.innerHTML = `
                <div class="trade-left">
                    <span class="trade-side-badge ${side}">${side}</span>
                    <div class="trade-info">
                        <div class="trade-player">${trade.player}</div>
                        <div class="trade-detail">
                            <span class="prop-badge ${propClass}">${trade.prop_type}</span>
                            <span>${trade.line}</span>
                        </div>
                    </div>
                </div>
                <div class="trade-right">
                    <div>
                        <div class="trade-price">${priceDisplay}</div>
                        <div class="trade-contracts">${trade.count} contracts</div>
                    </div>
                    <div class="trade-dollar">${formatDollar(trade.dollar_amount)}</div>
                    ${evHtml}
                    <div class="trade-time">${trade.time_str}</div>
                </div>
            `;
            return card;
        }

        function renderAllTrades() {
            const feedPanel = document.getElementById('feedPanel');
            const empty = document.getElementById('feedEmpty');

            if (state.trades.length === 0) {
                if (!empty) {
                    feedPanel.innerHTML = `
                        <div class="feed-empty" id="feedEmpty">
                            <div class="feed-empty-icon">&#9889;</div>
                            <div>Waiting for trades...</div>
                            <div style="font-size: 12px;">NBA prop trades will appear here in real-time</div>
                        </div>`;
                }
                return;
            }

            feedPanel.innerHTML = '';
            state.trades.forEach((trade, i) => {
                feedPanel.appendChild(createTradeCard(trade, i, false));
            });
        }

        function prependTrade(trade) {
            const feedPanel = document.getElementById('feedPanel');
            const empty = document.getElementById('feedEmpty');
            if (empty) empty.remove();

            // Reindex existing cards
            feedPanel.querySelectorAll('.trade-card').forEach(card => {
                card.dataset.index = parseInt(card.dataset.index) + 1;
            });

            const card = createTradeCard(trade, 0, true);
            feedPanel.insertBefore(card, feedPanel.firstChild);
        }

        function renderStats() {
            const s = state.stats;
            if (!s || !s.total_trades) return;

            document.getElementById('statTotalTrades').textContent = formatNumber(s.total_trades);
            document.getElementById('statTotalContracts').textContent = formatNumber(s.total_contracts);
            document.getElementById('statTotalVolume').textContent = formatDollar(s.total_dollar_volume);
            document.getElementById('headerTrades').textContent = formatNumber(s.total_trades);
            document.getElementById('headerVolume').textContent = formatDollar(s.total_dollar_volume);

            // Top Trades
            const tradesEl = document.getElementById('topTrades');
            if (s.top_trades && s.top_trades.length > 0) {
                tradesEl.innerHTML = s.top_trades.map((t, i) => {
                    const side = t.taker_side;
                    const price = side === 'yes' ? `${t.yes_price}\u00A2` : `${t.no_price}\u00A2`;
                    const sideColor = side === 'yes' ? '#22c55e' : '#ef4444';
                    const propClass = t.prop_type.toLowerCase();
                    return `
                    <div class="stat-row">
                        <span class="stat-rank">${i + 1}</span>
                        <span class="stat-name">
                            ${t.player} <span class="prop-badge ${propClass}" style="margin-left:4px;">${t.prop_type}</span>
                            <span style="color:#71717a;margin-left:4px;">${t.count}ct @ ${price} <span style="color:${sideColor};font-weight:600;">${side.toUpperCase()}</span></span>
                        </span>
                        <span class="stat-volume">${formatDollar(t.dollar_amount)} <span style="color:#52525b;font-weight:400;font-size:11px;">${t.time_str}</span></span>
                    </div>`;
                }).join('');
            }

            // Volume by Prop Type
            const propBars = document.getElementById('propTypeBars');
            if (s.volume_by_prop_type) {
                const types = ['Points', 'Rebounds', 'Assists', 'Threes'];
                const maxVol = Math.max(...types.map(t => (s.volume_by_prop_type[t] || {}).dollar_volume || 0), 1);
                propBars.innerHTML = types.map(t => {
                    const vol = (s.volume_by_prop_type[t] || {}).dollar_volume || 0;
                    const pct = (vol / maxVol * 100).toFixed(1);
                    return `
                        <div class="prop-bar-container">
                            <div class="prop-bar-header">
                                <span class="prop-bar-name">${t}</span>
                                <span class="prop-bar-value">${formatDollar(vol)}</span>
                            </div>
                            <div class="prop-bar-track">
                                <div class="prop-bar-fill ${t.toLowerCase()}" style="width: ${pct}%"></div>
                            </div>
                        </div>
                    `;
                }).join('');
            }

            // Hot Markets
            const marketsEl = document.getElementById('hotMarkets');
            if (s.top_markets && s.top_markets.length > 0) {
                marketsEl.innerHTML = s.top_markets.map((m, i) => `
                    <div class="stat-row">
                        <span class="stat-rank">${i + 1}</span>
                        <span class="stat-name">${m.title || m.ticker}</span>
                        <span class="stat-volume">${formatDollar(m.dollar_volume)} <span style="color:#71717a;font-weight:400;">(${m.count})</span></span>
                    </div>
                `).join('');
            }
        }

        function renderCheapNos() {
            const container = document.getElementById('cheapNosFeed');
            const unhideBtn = document.getElementById('unhideAllBtn');
            const items = (state.cheapNos || []).filter(item => !state.hiddenTickers.has(item.ticker));
            unhideBtn.style.display = state.hiddenTickers.size > 0 ? '' : 'none';
            if (items.length === 0) {
                container.innerHTML = state.hiddenTickers.size > 0
                    ? '<div style="color: #52525b; font-size: 13px;">All contracts hidden</div>'
                    : '<div style="color: #52525b; font-size: 13px;">No cheap NO contracts found</div>';
                return;
            }
            container.innerHTML = items.map(item => {
                const propClass = item.prop_type.toLowerCase();
                return `
                <div class="cheap-no-item">
                    <div class="cheap-no-left">
                        <span class="trade-side-badge no">NO</span>
                        <div>
                            <div class="cheap-no-player">${item.player} <span class="prop-badge ${propClass}">${item.prop_type}</span></div>
                            <div class="cheap-no-line">${item.line}</div>
                        </div>
                    </div>
                    <div class="cheap-no-right">
                        <span class="cheap-no-price">${item.no_price}&cent;</span>
                        <span class="cheap-no-qty">&times;${item.quantity}</span>
                        <button class="cheap-no-dismiss" onclick="state.hiddenTickers.add('${item.ticker}');renderCheapNos();" title="Hide">&times;</button>
                    </div>
                </div>`;
            }).join('');
        }

        function populateGameFilter(games) {
            const group = document.getElementById('filterGame');
            group.innerHTML = '<button class="toggle-btn active" data-value="all">All</button>';
            games.forEach(g => {
                const btn = document.createElement('button');
                btn.className = 'toggle-btn';
                btn.dataset.value = g;
                btn.textContent = g;
                group.appendChild(btn);
            });
            state.filters.games.clear();
        }

        function updateConnectionStatus() {
            const badge = document.getElementById('connectionBadge');
            const text = document.getElementById('connectionText');
            if (state.connected) {
                badge.className = 'connection-badge connected';
                text.textContent = 'Live';
            } else {
                badge.className = 'connection-badge disconnected';
                text.textContent = 'Disconnected';
            }
        }

        // ============================================================
        // WEBSOCKET
        // ============================================================
        function connectWebSocket() {
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsUrl = `${protocol}//${window.location.host}/ws`;
            const ws = new WebSocket(wsUrl);

            ws.onopen = () => {
                state.connected = true;
                updateConnectionStatus();
            };

            ws.onclose = () => {
                state.connected = false;
                updateConnectionStatus();
                setTimeout(connectWebSocket, 3000);
            };

            ws.onerror = () => {
                state.connected = false;
                updateConnectionStatus();
            };

            ws.onmessage = (event) => {
                const msg = JSON.parse(event.data);
                switch (msg.type) {
                    case 'bootstrap':
                        state.trades = msg.trades || [];
                        state.stats = msg.stats || {};
                        state.cheapNos = msg.cheap_nos || [];
                        if (msg.games) populateGameFilter(msg.games);
                        document.getElementById('headerTickers').textContent = msg.games ? msg.games.length : '--';
                        renderAllTrades();
                        renderStats();
                        renderCheapNos();
                        break;

                    case 'trade':
                        state.trades.unshift(msg.data);
                        prependTrade(msg.data);
                        // Quick inline stats update
                        document.getElementById('headerTrades').textContent = formatNumber((state.stats.total_trades || 0) + 1);
                        state.stats.total_trades = (state.stats.total_trades || 0) + 1;
                        state.stats.total_dollar_volume = (state.stats.total_dollar_volume || 0) + msg.data.dollar_amount;
                        state.stats.total_contracts = (state.stats.total_contracts || 0) + msg.data.count;
                        document.getElementById('statTotalTrades').textContent = formatNumber(state.stats.total_trades);
                        document.getElementById('statTotalContracts').textContent = formatNumber(state.stats.total_contracts);
                        document.getElementById('statTotalVolume').textContent = formatDollar(state.stats.total_dollar_volume);
                        document.getElementById('headerVolume').textContent = formatDollar(state.stats.total_dollar_volume);
                        break;

                    case 'stats_update':
                        // Only apply broadcast stats if on default 6h window
                        if (state.statsWindow === 21600) {
                            state.stats = msg.data;
                            renderStats();
                        }
                        break;

                    case 'cheap_nos_update':
                        state.cheapNos = msg.data || [];
                        renderCheapNos();
                        break;

                    case 'pong':
                        break;
                }
            };

            // Keepalive ping
            setInterval(() => {
                if (ws.readyState === WebSocket.OPEN) {
                    ws.send(JSON.stringify({ type: 'ping' }));
                }
            }, 30000);
        }

        // ============================================================
        // INFINITE SCROLL
        // ============================================================
        const feedPanel = document.getElementById('feedPanel');
        feedPanel.addEventListener('scroll', () => {
            if (state.loadingMore || state.allLoaded) return;
            if (feedPanel.scrollTop + feedPanel.clientHeight >= feedPanel.scrollHeight - 200) {
                loadMoreTrades();
            }
        });

        async function loadMoreTrades() {
            if (state.trades.length === 0) return;
            state.loadingMore = true;

            // Show loading indicator
            let loader = document.getElementById('feedLoader');
            if (!loader) {
                loader = document.createElement('div');
                loader.id = 'feedLoader';
                loader.style.cssText = 'text-align:center;padding:12px;color:#71717a;font-size:13px;';
                loader.textContent = 'Loading more trades...';
            }
            feedPanel.appendChild(loader);

            try {
                const oldestTs = state.trades[state.trades.length - 1].ts;
                const resp = await fetch(`/api/trades?before_ts=${oldestTs}&limit=100`);
                if (!resp.ok) return;
                const older = await resp.json();

                if (older.length === 0) {
                    state.allLoaded = true;
                    loader.textContent = 'All trades loaded';
                    return;
                }

                const startIdx = state.trades.length;
                older.forEach((trade, i) => {
                    state.trades.push(trade);
                    const card = createTradeCard(trade, startIdx + i, false);
                    feedPanel.insertBefore(card, loader);
                });

                if (older.length < 100) {
                    state.allLoaded = true;
                    loader.textContent = 'All trades loaded';
                } else {
                    loader.remove();
                }
            } catch (e) {
                loader.textContent = 'Failed to load more';
            } finally {
                state.loadingMore = false;
            }
        }

        // Start
        connectWebSocket();
    </script>
</body>
</html>
